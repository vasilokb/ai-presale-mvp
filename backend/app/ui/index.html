<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AI Presale MVP</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 24px;
        color: #1f2937;
      }
      h1 {
        margin-bottom: 8px;
      }
      .layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 24px;
        align-items: start;
      }
      .panel {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        background: #fff;
      }
      .doc-item {
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        border: 1px solid transparent;
      }
      .doc-item.active {
        background: #eef2ff;
        border-color: #c7d2fe;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #e5e7eb;
        padding: 8px;
        text-align: left;
      }
      th {
        background: #f9fafb;
      }
      input[type="number"] {
        width: 90px;
      }
      .actions {
        margin-top: 12px;
        display: flex;
        gap: 12px;
      }
      .status {
        margin-top: 12px;
        color: #6b7280;
      }
      .totals {
        margin-top: 16px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>AI Presale MVP</h1>
    <div class="layout">
      <div class="panel">
        <h2>Documents</h2>
        <div id="documents"></div>
      </div>
      <div class="panel">
        <h2>Document Result</h2>
        <div id="docMeta" class="status">Select a document.</div>
        <div id="tableContainer"></div>
        <div class="actions">
          <button id="recalcBtn" disabled>Recalculate expected + totals</button>
          <button id="saveBtn" disabled>Save as new version</button>
        </div>
        <div id="saveStatus" class="status"></div>
      </div>
    </div>
    <script>
      const documentsEl = document.getElementById("documents");
      const tableContainer = document.getElementById("tableContainer");
      const recalcBtn = document.getElementById("recalcBtn");
      const saveBtn = document.getElementById("saveBtn");
      const docMeta = document.getElementById("docMeta");
      const saveStatus = document.getElementById("saveStatus");

      let currentDocumentId = null;
      let currentResult = null;
      const roundStep = 0.5;

      function roundToStep(value) {
        return Math.round(value / roundStep) * roundStep;
      }

      async function loadDocuments() {
        const response = await fetch("/api/v1/documents");
        const docs = await response.json();
        documentsEl.innerHTML = "";
        docs.forEach((doc) => {
          const item = document.createElement("div");
          item.className = "doc-item";
          item.textContent = `${doc.document_id} (${doc.status})`;
          item.addEventListener("click", () => selectDocument(doc.document_id, item));
          documentsEl.appendChild(item);
        });
      }

      async function selectDocument(documentId, element) {
        currentDocumentId = documentId;
        saveStatus.textContent = "";
        document.querySelectorAll(".doc-item").forEach((el) => el.classList.remove("active"));
        element.classList.add("active");

        const response = await fetch(`/api/v1/documents/${documentId}/result`);
        if (!response.ok) {
          docMeta.textContent = "Result not available yet.";
          tableContainer.innerHTML = "";
          recalcBtn.disabled = true;
          saveBtn.disabled = true;
          return;
        }
        const payload = await response.json();
        currentResult = payload;
        docMeta.textContent = `Version ${payload.version}`;
        renderTable(payload);
        recalcBtn.disabled = false;
        saveBtn.disabled = false;
      }

      function renderTable(result) {
        const epics = result.epics || [];
        const rows = [];
        epics.forEach((epic) => {
          const tasks = epic.tasks || [];
          tasks.forEach((task) => {
            rows.push({ epic: epic.name, task });
          });
        });

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Epic</th>
              <th>Task</th>
              <th>Role</th>
              <th>Optimistic</th>
              <th>Most Likely</th>
              <th>Pessimistic</th>
              <th>Expected</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");
        rows.forEach((row, index) => {
          const pert = row.task.pert_hours || {};
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row.epic || ""}</td>
            <td>${row.task.name || ""}</td>
            <td>${row.task.role || ""}</td>
            <td><input type="number" step="0.5" value="${pert.optimistic ?? 0}" data-field="optimistic" data-index="${index}" /></td>
            <td><input type="number" step="0.5" value="${pert.most_likely ?? 0}" data-field="most_likely" data-index="${index}" /></td>
            <td><input type="number" step="0.5" value="${pert.pessimistic ?? 0}" data-field="pessimistic" data-index="${index}" /></td>
            <td><span data-expected="${index}">${pert.expected ?? 0}</span></td>
          `;
          tbody.appendChild(tr);
        });
        const totals = document.createElement("div");
        totals.className = "totals";
        totals.id = "totals";
        totals.textContent = `Total expected hours: ${result.totals?.expected_hours ?? 0}`;
        tableContainer.innerHTML = "";
        tableContainer.appendChild(table);
        tableContainer.appendChild(totals);

        tableContainer.querySelectorAll("input").forEach((input) => {
          input.addEventListener("change", handleInputChange);
        });
      }

      function handleInputChange(event) {
        const index = Number(event.target.dataset.index);
        const field = event.target.dataset.field;
        const tasks = collectTasks();
        const task = tasks[index];
        task.pert_hours[field] = Number(event.target.value);
        updateExpected(index, task.pert_hours);
      }

      function collectTasks() {
        const epics = currentResult.epics || [];
        const tasks = [];
        epics.forEach((epic) => {
          (epic.tasks || []).forEach((task) => tasks.push(task));
        });
        return tasks;
      }

      function updateExpected(index, pert) {
        const optimistic = Number(pert.optimistic || 0);
        const mostLikely = Number(pert.most_likely || 0);
        const pessimistic = Number(pert.pessimistic || 0);
        const expected = roundToStep((optimistic + 4 * mostLikely + pessimistic) / 6);
        pert.expected = Number(expected.toFixed(2));
        const cell = tableContainer.querySelector(`[data-expected="${index}"]`);
        if (cell) {
          cell.textContent = pert.expected;
        }
      }

      function recalcTotals() {
        const tasks = collectTasks();
        let total = 0;
        tasks.forEach((task, index) => {
          updateExpected(index, task.pert_hours || {});
          total += Number(task.pert_hours?.expected || 0);
        });
        if (!currentResult.totals) {
          currentResult.totals = {};
        }
        currentResult.totals.expected_hours = Number(total.toFixed(2));
        const totalsEl = document.getElementById("totals");
        if (totalsEl) {
          totalsEl.textContent = `Total expected hours: ${currentResult.totals.expected_hours}`;
        }
      }

      recalcBtn.addEventListener("click", () => {
        recalcTotals();
        saveStatus.textContent = "Recalculated expected values.";
      });

      saveBtn.addEventListener("click", async () => {
        recalcTotals();
        const payload = { result_json: currentResult };
        const response = await fetch(`/api/v1/documents/${currentDocumentId}/result/version`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (response.ok) {
          const data = await response.json();
          docMeta.textContent = `Version ${data.version}`;
          saveStatus.textContent = "Saved new version.";
        } else {
          saveStatus.textContent = "Failed to save new version.";
        }
      });

      loadDocuments();
    </script>
  </body>
</html>
